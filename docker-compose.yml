services:
  monerod:
    image: sethsimmons/simple-monerod:latest
    container_name: monero-node
    restart: unless-stopped
    ports:
      - "38081:38081" # P2P
      - "127.0.0.1:38089:38089" # RPC
    volumes:
      - ./data/monerod:/home/monero/.bitmonero
    command:
      - --${MONERO_NETWORK:-stagenet}
      - --rpc-bind-ip=0.0.0.0
      - --rpc-bind-port=38089
      - --confirm-external-bind
      - --restricted-rpc
      - --log-level=1

  wallet-rpc:
    image: sethsimmons/simple-monero-wallet-rpc:latest
    container_name: monero-wallet-rpc
    restart: unless-stopped
    ports:
      - "127.0.0.1:38083:38083" # Localhost only Wallet RPC
    volumes:
      - ./data/wallet:/home/monero
    command:
      - --${MONERO_NETWORK:-stagenet}
      - --rpc-bind-port=38083
      - --wallet-dir=/home/monero
      - --disable-rpc-login
      # Primary Node: The local monerod service
      - --daemon-address=monero-node:38089
      # Bootstrap Node: Remote fallback to allow immediate use while local node syncs
      - --bootstrap-daemon-address=${MONERO_BOOTSTRAP_ADDRESS:-rpc-${MONERO_NETWORK:-stagenet}.kyc.rip:443}
      - --daemon-ssl=enabled # Note: local monerod is restricted-rpc but usually doesn't need SSL internally, but we'll keep it for the bootstrap fallback
      - --daemon-ssl-allow-any-cert
    depends_on:
      - monerod

  gateway:
    image: ghcr.io/kyc-rip/ripley-xmr-gateway:latest
    container_name: ripley-xmr-gateway
    restart: unless-stopped
    depends_on:
      - wallet-rpc
    ports:
      - "127.0.0.1:38084:38084"
    environment:
      - WALLET_RPC_URL=http://wallet-rpc:38083/json_rpc
      - MONERO_NETWORK=${MONERO_NETWORK:-stagenet}
      - AGENT_API_KEY=${AGENT_API_KEY:-ripley_secure_key_123}

  tunnel:
    image: cloudflare/cloudflared
    container_name: monero-gateway-tunnel
    restart: unless-stopped
    command: tunnel --no-autoupdate run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    depends_on:
      - gateway
